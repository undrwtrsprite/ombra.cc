<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Image to PDF ‚Äî ombra tools</title>
  <meta name="description" content="Convert images to a single PDF with page size and fit options." />
  <link rel="stylesheet" href="/assets/styles/base.css" />
</head>
<body>
  <div class="bg-layer bg-gradient"></div>
  <div class="bg-layer bg-mesh"></div>
  <nav class="nav">
    <ul>
      <li><a href="/" class="logo">ombra</a></li>
      <li><a href="/index.html#tools">Tools</a></li>
    </ul>
  </nav>

  <main class="tool-container">
    <div class="tool-card reveal visible">
      <div class="tool-header">
        <div class="tool-icon">üñºÔ∏è</div>
        <h1>Image to PDF</h1>
      </div>
      <div class="tool-body">
        <div class="control-row">
          <label>Images</label>
          <input type="file" id="images" accept="image/*" multiple />
        </div>
        <div class="control-row">
          <label>Page Size</label>
          <select id="pageSize">
            <option value="auto">Auto (match image)</option>
            <option value="A4P">A4 Portrait</option>
            <option value="A4L">A4 Landscape</option>
            <option value="LTP">Letter Portrait</option>
            <option value="LTL">Letter Landscape</option>
          </select>
          <label>Fit</label>
          <select id="fit">
            <option value="contain">Contain (keep aspect)</option>
            <option value="cover">Cover (fill page)</option>
            <option value="stretch">Stretch</option>
          </select>
          <label>Margin</label>
          <input type="number" id="margin" value="16" min="0" step="1" />
        </div>
        <div class="progress-container" id="progressContainer" style="display:none; margin-top:16px;">
          <div class="progress-info" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;font-size:14px;color:rgba(255,255,255,0.9);">
            <span class="progress-status" id="progressStatus" style="font-weight:600;color:#9333ea;">Processing...</span>
            <span id="progressPercent">0%</span>
          </div>
          <div class="progress-details" id="progressDetails" style="font-size:13px;opacity:0.7;margin-top:4px;">Preparing images...</div>
          <div class="progress-bar-container" style="width:100%;height:8px;background:rgba(255,255,255,0.1);border-radius:4px;overflow:hidden;margin-top:12px;">
            <div class="progress-bar-fill" id="progressBarFill" style="height:100%;background:linear-gradient(90deg, #9333ea, #7c3aed);width:0%;transition:width 0.3s ease;border-radius:4px;"></div>
          </div>
        </div>
        <div id="errorMessage" style="display:none;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);border-radius:8px;padding:12px;margin-top:16px;color:#ef4444;"></div>
        <div class="actions">
          <button class="btn-primary" id="buildBtn" disabled>Create PDF</button>
          <a class="btn-secondary" id="download" download="images.pdf" style="display:none;">Download</a>
        </div>
        <p class="note">Runs fully offline in your browser.</p>
      </div>
    </div>
  </main>

  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    
  <!-- Service Worker Registration for offline support -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then(registration => {
            console.log('Service Worker registered successfully:', registration.scope);
          })
          .catch(error => {
            console.log('Service Worker registration failed:', error);
          });
      });
    }
  </script>
  <script src="/assets/scripts/tool-performance.js"></script>
  <script src="/assets/scripts/effects.js"></script>
  <script src="/assets/scripts/back-button.js"></script>
  <script>
    const imagesInput = document.getElementById('images');
    const pageSizeSelect = document.getElementById('pageSize');
    const fitSelect = document.getElementById('fit');
    const marginInput = document.getElementById('margin');
    const buildBtn = document.getElementById('buildBtn');
    const download = document.getElementById('download');
    const progressContainer = document.getElementById('progressContainer');
    const progressStatus = document.getElementById('progressStatus');
    const progressPercent = document.getElementById('progressPercent');
    const progressDetails = document.getElementById('progressDetails');
    const progressBarFill = document.getElementById('progressBarFill');
    const errorMessage = document.getElementById('errorMessage');

    function showError(msg) {
      errorMessage.textContent = msg;
      errorMessage.style.display = 'block';
      progressContainer.style.display = 'none';
      setTimeout(() => { errorMessage.style.display = 'none'; }, 5000);
    }

    function showProgress(show = true) {
      progressContainer.style.display = show ? 'block' : 'none';
      if (!show) {
        progressBarFill.style.width = '0%';
        progressPercent.textContent = '0%';
      }
    }

    let imageFiles = [];
    imagesInput.addEventListener('change', () => {
      imageFiles = Array.from(imagesInput.files || []);
      buildBtn.disabled = imageFiles.length === 0;
      errorMessage.style.display = 'none';
    });

    const POINTS_PER_MM = 2.8346456693;
    const sizes = {
      A4P: [210 * POINTS_PER_MM, 297 * POINTS_PER_MM],
      A4L: [297 * POINTS_PER_MM, 210 * POINTS_PER_MM],
      LTP: [216 * POINTS_PER_MM, 279 * POINTS_PER_MM],
      LTL: [279 * POINTS_PER_MM, 216 * POINTS_PER_MM]
    };

    buildBtn.addEventListener('click', async () => {
      if (imageFiles.length === 0) {
        showError('Please select at least one image file');
        return;
      }

      buildBtn.disabled = true; 
      buildBtn.textContent = 'Building‚Ä¶'; 
      download.style.display = 'none';
      showProgress(true);
      errorMessage.style.display = 'none';

      try {
        progressStatus.textContent = 'Initializing PDF...';
        progressDetails.textContent = 'Creating document...';
        progressBarFill.style.width = '5%';
        progressPercent.textContent = '5%';

        const { PDFDocument } = window.pdfLib;
        const doc = await PDFDocument.create();
        const margin = Number(marginInput.value) || 0;
        const totalFiles = imageFiles.length;

        for (let i = 0; i < imageFiles.length; i++) {
          const file = imageFiles[i];
          const progress = 5 + ((i / totalFiles) * 85);
          progressBarFill.style.width = `${progress}%`;
          progressPercent.textContent = `${Math.round(progress)}%`;
          progressStatus.textContent = `Processing image ${i + 1} of ${totalFiles}`;
          progressDetails.textContent = `Adding: ${file.name}`;

          const bytes = await file.arrayBuffer();
          const isJpeg = /jpe?g$/i.test(file.name) || file.type === 'image/jpeg';
          const embedded = isJpeg ? await doc.embedJpg(bytes) : await doc.embedPng(bytes);
          const imgW = embedded.width;
          const imgH = embedded.height;

          let pageWidth, pageHeight;
          if (pageSizeSelect.value === 'auto') {
            pageWidth = imgW + margin * 2;
            pageHeight = imgH + margin * 2;
          } else {
            [pageWidth, pageHeight] = sizes[pageSizeSelect.value];
          }

          const page = doc.addPage([pageWidth, pageHeight]);
          const targetW = pageWidth - margin * 2;
          const targetH = pageHeight - margin * 2;
          let drawW = targetW, drawH = targetH;

          if (fitSelect.value === 'contain') {
            const scale = Math.min(targetW / imgW, targetH / imgH);
            drawW = imgW * scale; drawH = imgH * scale;
          } else if (fitSelect.value === 'cover') {
            const scale = Math.max(targetW / imgW, targetH / imgH);
            drawW = imgW * scale; drawH = imgH * scale;
          } else {
            drawW = targetW; drawH = targetH;
          }

          const x = (pageWidth - drawW) / 2;
          const y = (pageHeight - drawH) / 2;
          page.drawImage(embedded, { x, y, width: drawW, height: drawH });

          // Yield to browser for better performance
          await new Promise(resolve => rafUpdate(resolve));
        }

        progressStatus.textContent = 'Finalizing...';
        progressDetails.textContent = 'Saving PDF document...';
        progressBarFill.style.width = '95%';
        progressPercent.textContent = '95%';

        const out = await doc.save();
        const blob = new Blob([out], { type: 'application/pdf' });
        const url = URL.createObjectURL(blob);
        download.href = url; 
        download.style.display = 'inline-block';

        progressBarFill.style.width = '100%';
        progressPercent.textContent = '100%';
        progressStatus.textContent = 'Complete!';
        progressDetails.textContent = `Successfully created PDF with ${totalFiles} image${totalFiles > 1 ? 's' : ''}`;

        setTimeout(() => {
          showProgress(false);
        }, 2000);
      } catch (e) {
        showError('Failed to build PDF. Please ensure all files are valid images.');
        showProgress(false);
      } finally {
        buildBtn.disabled = false; 
        buildBtn.textContent = 'Create PDF';
      }
    });
  </script>
</body>
</html>


