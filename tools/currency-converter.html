<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Currency Converter â€” ombra tools</title>
  <meta name="description" content="Real-time currency converter with support for over 160 currencies. Works offline with last known rates.">
  <meta name="theme-color" content="#09090b" />
  <link rel="stylesheet" href="/assets/styles/base.css?v=52">
  <link rel="manifest" href="/manifest.json" />
  <style>
    .converter-wrapper {
      display: flex;
      flex-direction: column;
      gap: 8px;
      position: relative;
      margin-bottom: 24px;
    }
    
    .currency-card {
      background: var(--surface-strong);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      transition: all 0.2s ease;
    }

    .currency-card:focus-within {
      background: var(--surface-hover);
      border-color: var(--border);
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }

    .amount-group {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .amount-label {
      font-size: 12px;
      color: var(--text-muted);
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .currency-input {
      width: 100%;
      background: transparent;
      border: none;
      color: var(--text-main);
      font-size: 28px;
      font-weight: 700;
      padding: 0;
      outline: none;
      font-family: inherit;
    }

    .currency-input::placeholder {
      color: rgba(255,255,255,0.2);
    }

    .currency-select {
      appearance: none;
      background: var(--input-bg);
      border: 1px solid var(--border);
      color: var(--text-main);
      padding: 8px 32px 8px 12px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      outline: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 8px center;
      min-width: 100px;
    }

    .currency-select:hover {
      background-color: var(--surface-hover);
    }

    .swap-container {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 10;
    }

    .swap-btn {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: var(--surface-strong);
      border: 4px solid var(--surface); /* Matches card background for gap effect */
      color: var(--text-main);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      padding: 0;
    }

    .swap-btn:hover {
      transform: scale(1.1) rotate(180deg);
      background: var(--ios-ring);
      color: white;
      box-shadow: 0 8px 24px rgba(99, 102, 241, 0.4);
    }

    .rate-display {
      text-align: center;
      color: var(--text-muted);
      font-size: 14px;
      margin-bottom: 24px;
      font-weight: 500;
    }

    .rate-info {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-top: 24px;
      text-align: center;
      padding: 12px;
      background: rgba(255,255,255,0.03);
      border-radius: 8px;
    }

    @media (max-width: 480px) {
      .currency-card {
        padding: 16px;
        gap: 12px;
      }
      .currency-input {
        font-size: 24px;
      }
      .currency-select {
        min-width: 80px;
        padding: 8px 24px 8px 8px;
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <div class="bg-layer bg-gradient"></div>
  <div class="bg-layer bg-mesh"></div>

  <nav class="nav">
    <ul>
      <li><a href="/" class="logo">ombra</a></li>
      <li><a href="/index.html#tools">Tools</a></li>
    </ul>
  </nav>

  <main class="tool-container">
    <div class="tool-card reveal visible">
      <div class="tool-header">
        <div class="tool-icon">ðŸ’±</div>
        <h1>Currency Converter</h1>
      </div>
      <div class="tool-body">
        <div class="converter-wrapper">
          <div class="currency-card">
            <div class="amount-group">
              <label class="amount-label">Amount</label>
              <input type="number" id="amount" class="currency-input" value="1" min="0" step="any" placeholder="0">
            </div>
            <select id="fromCurrency" class="currency-select"></select>
          </div>
          
          <div class="swap-container">
            <button class="swap-btn" id="swapBtn" title="Swap currencies">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 16V4M7 4L3 8M7 4L11 8M17 8v12M17 20l4-4M17 20l-4-4"/></svg>
            </button>
          </div>

          <div class="currency-card">
            <div class="amount-group">
              <label class="amount-label">Converted to</label>
              <input type="text" id="resultInput" class="currency-input" readonly placeholder="0">
            </div>
            <select id="toCurrency" class="currency-select"></select>
          </div>
        </div>

        <div class="rate-display" id="rateDisplay"></div>

        <div id="chartContainer" style="display:none; margin-top: 24px; height: 250px; background: rgba(0,0,0,0.2); border-radius: 16px; padding: 16px;">
          <canvas id="rateChart"></canvas>
        </div>

        <div class="rate-info" id="lastUpdated">
          Fetching latest rates...
        </div>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const amountInput = document.getElementById('amount');
    const fromSelect = document.getElementById('fromCurrency');
    const toSelect = document.getElementById('toCurrency');
    const swapBtn = document.getElementById('swapBtn');
    const resultInput = document.getElementById('resultInput');
    const rateDisplayEl = document.getElementById('rateDisplay');
    const lastUpdatedEl = document.getElementById('lastUpdated');

    // Common currencies to show first
    const commonCurrencies = ['USD', 'EUR', 'GBP', 'JPY', 'AUD', 'CAD', 'CHF', 'CNY', 'INR'];
    let rates = {};
    let chartInstance = null;

    async function init() {
      // Load cached data first
      const cached = localStorage.getItem('currency_rates');
      if (cached) {
        const data = JSON.parse(cached);
        // Use cache if less than 24 hours old
        if (Date.now() - data.timestamp < 24 * 60 * 60 * 1000) {
          rates = data.rates;
          populateSelects(Object.keys(rates));
          updateLastUpdated(data.timestamp);
        }
      }

      // Fetch fresh data
      try {
        const response = await fetch('https://open.er-api.com/v6/latest/USD');
        const data = await response.json();
        
        if (data.result === 'success') {
          rates = data.rates;
          localStorage.setItem('currency_rates', JSON.stringify({
            timestamp: Date.now(),
            rates: rates
          }));
          
          // Repopulate if it was empty or just to refresh
          if (fromSelect.options.length === 0) {
            populateSelects(Object.keys(rates));
          }
          updateLastUpdated(Date.now());
          convert();
          updateChart();
        }
      } catch (e) {
        console.log('Using offline rates');
        if (Object.keys(rates).length === 0) {
          resultEl.textContent = 'Error';
          rateDisplayEl.textContent = 'Could not load exchange rates. Please check your connection.';
        }
      }
    }

    function populateSelects(currencyList) {
      const sorted = currencyList.sort();
      // Move common currencies to top
      const options = sorted.map(c => `<option value="${c}">${c}</option>`).join('');
      
      fromSelect.innerHTML = options;
      toSelect.innerHTML = options;

      // Set defaults
      fromSelect.value = 'USD';
      toSelect.value = 'EUR';
      
      // Restore previous selection if available
      const savedFrom = localStorage.getItem('currency_from');
      const savedTo = localStorage.getItem('currency_to');
      if (savedFrom && rates[savedFrom]) fromSelect.value = savedFrom;
      if (savedTo && rates[savedTo]) toSelect.value = savedTo;
      
      convert();
      updateChart();
    }

    function convert() {
      if (!rates[fromSelect.value] || !rates[toSelect.value]) return;

      const amount = parseFloat(amountInput.value) || 0;
      const fromRate = rates[fromSelect.value];
      const toRate = rates[toSelect.value];
      
      // Base is USD in this API
      const rate = toRate / fromRate;
      const result = amount * rate;

      resultInput.value = result.toLocaleString(undefined, {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2,
      });

      rateDisplayEl.textContent = `1 ${fromSelect.value} = ${rate.toFixed(4)} ${toSelect.value}`;
      
      // Save selection
      localStorage.setItem('currency_from', fromSelect.value);
      localStorage.setItem('currency_to', toSelect.value);
    }

    function updateLastUpdated(timestamp) {
      const date = new Date(timestamp);
      lastUpdatedEl.textContent = `Rates updated: ${date.toLocaleString()}`;
    }

    async function updateChart() {
      const from = fromSelect.value;
      const to = toSelect.value;
      
      if (from === to) {
        document.getElementById('chartContainer').style.display = 'none';
        return;
      }

      const end = new Date();
      const start = new Date();
      start.setDate(start.getDate() - 30);
      
      const formatDate = (d) => d.toISOString().split('T')[0];
      
      try {
        const response = await fetch(`https://api.frankfurter.app/${formatDate(start)}..${formatDate(end)}?from=${from}&to=${to}`);
        if (!response.ok) throw new Error('Data not available');
        
        const data = await response.json();
        if (!data.rates) return;

        const labels = Object.keys(data.rates);
        const values = labels.map(date => data.rates[date][to]);
        
        renderChart(labels, values, from, to);
        document.getElementById('chartContainer').style.display = 'block';
      } catch (e) {
        document.getElementById('chartContainer').style.display = 'none';
      }
    }

    function renderChart(labels, values, from, to) {
      const ctx = document.getElementById('rateChart').getContext('2d');
      
      if (chartInstance) {
        chartInstance.destroy();
      }

      const gradient = ctx.createLinearGradient(0, 0, 0, 400);
      gradient.addColorStop(0, 'rgba(99, 102, 241, 0.5)');
      gradient.addColorStop(1, 'rgba(99, 102, 241, 0.0)');

      chartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: `${from} to ${to}`,
            data: values,
            borderColor: '#6366f1',
            backgroundColor: gradient,
            borderWidth: 2,
            fill: true,
            tension: 0.4,
            pointRadius: 0,
            pointHitRadius: 10
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } },
          scales: {
            x: { display: false },
            y: { display: true, grid: { color: 'rgba(255, 255, 255, 0.05)' }, ticks: { color: '#94a3b8' } }
          },
          interaction: { mode: 'nearest', axis: 'x', intersect: false }
        }
      });
    }

    // Event listeners
    amountInput.addEventListener('input', convert);
    fromSelect.addEventListener('change', () => { convert(); updateChart(); });
    toSelect.addEventListener('change', () => { convert(); updateChart(); });
    
    swapBtn.addEventListener('click', () => {
      const temp = fromSelect.value;
      fromSelect.value = toSelect.value;
      toSelect.value = temp;
      convert();
      updateChart();
      
      // Animation
      swapBtn.style.transform = 'rotate(180deg)';
      setTimeout(() => swapBtn.style.transform = '', 200);
    });

    init();
  </script>

  <!-- Service Worker Registration -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js');
      });
    }
  </script>
  <script src="/assets/scripts/effects.js"></script>
  <script src="/assets/scripts/back-button.js"></script>
</body>
</html>